<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>PostgreSQL – Particularités, fonctionnalités et astuces</title>

		<meta name="description" content="PostgreSQL pour les développeurs, les apprentis DBA et les utilisateurs de MySQL">
		<meta name="author" content="xavier-rdo">

		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/custom.css">
		<link rel="stylesheet" href="css/theme/black.css" id="theme">

		<!-- Code syntax highlighting -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
				<section>
					<h1>PostgreSQL</h1>
					<h4>Fonctionnalités à l'usage des développeurs, des apprentis DBA et des utilisateurs de MySQL</h4>
					<p>
						<small>
						<ul>
							<li>Novembre 2015</li>
							<li>Version de PostgreSQL de référence: 9.4</li>
						 	<li>Support de la présentation : <a target="_blank" href="https://github.com/hakimel/reveal.js">Reveal.js</a></li>
						 	<li>
						 		<i>Cette présentation propose un aperçu de certaines fonctionnalités de PostgreSQL,
								elle ne prétend nullement à l'exhaustivité.</i>
						 	</li>
						</ul>
						</small>
					</p>
					<p><img src="./images/postgresql-logo.png"></p>
				</section>

				<section>
					<h2>PostgreSQL en quelques mots</h2>
					<ul>
						<li>SGBD Open Source et (très?) performant</li>
						<li>Site officiel : <a href="www.postgresql.org" target="_blank">www.postgresql.org</a></li>
						<li>Version 1 diffusée à quelques utilisateurs en juin 1989</li>
						<li>Créateur : Michael Stonebraker (Berkeley)</li>
						<li>Version actuelle : 9.4 (décembre 2014)</li>
					</ul>
				</section>
				<section>
					<ul>
						<li>Nom officiel : PostgreSQL ("postgres" dans l'usage)</li>
						<li>Disponible pour la plupart des OS (Windows, MacOS, Unix, Linux, etc.)</li>
						<li>Drivers disponibles dans la plupart des langages (Php, Java, Python, Golang, Node.js, etc.)</li>
						<li>Des fonctionnalités, en veux-tu, en voilà ! Voir la suite ...</li>
					</ul>
				</section>

				<section>
					<h2>Terminologie</h2>
					<ul>
						<li>
							Le terme <strong><i>Cluster</i></strong> désigne souvent une instance de PostgreSQL (comprendre "cluster de bases de données")
						</li>
						<li>
							<strong>DDL</strong> : Data Definition Language (schema des données : CREATE TABLE, ALTER TABLE, INDEXES, RENAME, etc.)
						</li>
						<li>
							<strong>DML</strong> : Data Manipulation Language (INSERT, DELETE, UPDATE, SELECT, etc.)
						</li>
						<li>
							En SQL, le terme <strong><i>Relation</i></strong> désigne souvent une table (et non pas une association)
						</li>
					</ul>
				</section>

				<section>
					<h2>Outils d'administration [DBA]</h2>
					<p><a href="http://www.pgadmin.org/" target="_blank">http://www.pgadmin.org/</a></p>
					<p><img src="images/pgadmin.png"></p>
				</section>

				<section>
					<h2>Outils d'administration [DBA]</h2>
					<p><a href="http://phppgadmin.sourceforge.net" target="_blank">http://phppgadmin.sourceforge.net</a></p>
					<p><img src="images/phpPgAdmin.jpg"></p>
				</section>

				<section data-markdown>
					<script type="text/template">
					##Outils d'administration [DBA]
					##psql
					```
					$ psql -U myuser -h 127.0.0.1 mydatabase
					Password for user myuser:
					psql (9.4.2)
					SSL connection (cipher: DHE-RSA-AES256-GCM-SHA384, bits: 256)
					Type "help" for help.

					mydatabase=# SELECT * FROM mytable;
					```
					'</script>
				</section>

				<section>
					<h2>Les Rôles [DBA]</h2>
					<ul>
						<li class="fragment">Rôle de login et rôle de groupe <small>(1)</small></li>
						<li class="fragment">
							Créer un rôle de login :
							<ul>
								<li><strong><i>CREATE ROLE yves LOGIN PASSWORD 'my-password';</i></strong></li>
								<li><strong><i>CREATE ROLE myadmin LOGIN PASSWORD 'my-password' SUPERUSER;</i></strong></li>
							</ul>
						</li>
						<li class="fragment">
							Créer un rôle de groupe :
							<ul>
								<li><strong><i>CREATE ROLE admin [INHERIT|NOINHERIT];</i></strong>&nbsp;<small>(2)</small></li>
							</ul>
						</li>
						<li class="fragment">
							Ajouter un rôle de login à un rôle de groupe :
							<ul>
								<li><strong><i>GRANT admin TO yves;</i></strong></li>
							</ul>
						</li>
					</ul>
					<br/><br/>
					<ul>
					<small>
						<li>(1) CREATE USER et CREATE GROUP sont dépréciés. CREATE USER est un alias de CREATE ROLE</li>
						<li>(2) INHERIT/NOINHERIT : les privilèges sont-ils propagés aux utilisateurs du groupe ?</li>
						<li>
							L'impersonnation est possible (<i>SET ROLE</i>).
							<a href="http://www.postgresql.org/docs/9.3/static/sql-set-role.html" target="_blank">
								Cf. documentation
							</a>.
						</li>
						<li>
							En savoir plus sur les rôles :
							<a href="http://www.postgresql.org/docs/current/static/sql-createrole.html" target="_blank">
							http://www.postgresql.org/docs/current/static/sql-createrole.html
							</a>
						</li>
					</small>
					</ul>
				</section>

				<section data-markdown>
					<script type="text/template">
					##Liste des rôles [DBA]
					##psql
					La commande \du permet de lister les rôles :
					```
					$ psql -U postgres -h 127.0.0.1
					postgres=# \du
					                             List of roles
					 Role name |                   Attributes                   | Member of
					-----------+------------------------------------------------+-----------
					 postgres  | Superuser, Create role, Create DB, Replication | {}
					 admin     | Create DB                                      | {}

					```
					##SQL
					```
					SELECT * FROM pg_roles;
					```
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
					##Update avec jointure [SQL/DML]
					MySQL :
					```
					UPDATE product p
					INNER JOIN category c ON (p.category_id = c.id)
					SET p.price = p.price * 1.1
					WHERE c.name LIKE 'Sport%'
					```
					PostgreSQL :
					```
					UPDATE product
					SET price = price * 1.1
					FROM category
					WHERE product.category_id = category.id
					AND category.name LIKE 'Sport%'
					```
					<p>
					<small>
						<br/>
					    Type de requête souvent nécessaire lorsque l'on souhaite mettre à jour les données d'une table en se basant sur une
					    (ou plusieurs) condition(s) portée(s) par une table associée.
					</small>
					</p>
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
					##Le langage PL/PGSQL [DEV]
					Structure d'une fonction PL/PGSQL :
					```
						CREATE or REPLACE FUNCTION my_wonderful_function()
						RETURNS void AS
						$$
						DECLARE
							# Initialize your variables here
							rank integer := 0;
						BEGIN
						    # Body of the function
						END;
						$$ LANGUAGE plpgsql;
					```
					'</script>
				</section>

				<section class="hljs-condensed">
					<h2>Le langage PL/PGSQL [DEV]</h2>
					<pre>
						<code class="hljs" data-trim contenteditable>
CREATE or REPLACE FUNCTION init_product_ranks()
RETURNS void AS $$
DECLARE
  rank integer := 0;
  current_category_id integer := 0;
  products CURSOR FOR SELECT * FROM product ORDER BY category_id;
BEGIN
  FOR product_row IN products LOOP
    -- reset rank to zero if category id has changed
    IF product_row.category_id <> current_category_id THEN
      current_category_id := product_row.category_id;
      rank := 0;
    END IF;
    EXECUTE 'UPDATE product SET position = ' || rank || ' WHERE id = ' || product_row.id;
    rank := rank + 1;
  END LOOP;
END;
$$ LANGUAGE plpgsql;
						</code>
					</pre>
					<p>
					<small>
					<strong>Contexte applicatif</strong> : fonction utilisée dans un script de migration pour initialiser l'ordre des produits dans le périmètre de leur catégorie, après création en table d'un nouveau champ 'rank' sur des données existantes (positionner toutes les valeurs à zéro aboutissait à des résultats complètement erratiques dans le code applicatif ; la librairie Php utilisée pour mettre à jour les tris géraient très mal les données non triées par défaut)
					</small>
					</p>
				</section>

				<section data-markdown class="hljs-condensed">
					<script type="text/template">
					##Fichiers de config [DBA]
					Sous Debian/Ubuntu : /etc/postgresql/9.4/main/xxxxxx.conf
					###Le fichier postgresql.conf
					```
					(CONFIG) FILE LOCATIONS /
					CONNECTIONS AND AUTHENTICATION (port, max connections, SSL cert files, TCP keepalives, etc.) /
					RESOURCE USAGE (except WAL) : memory, disk, etc. /
					WRITE AHEAD LOG (wal level, checkpoints, archiving, etc) /
					REPLICATION / QUERY TUNING / ERROR REPORTING AND LOGGING / RUNTIME STATISTICS /
					AUTOVACUUM PARAMETERS / CLIENT CONNECTION DEFAULTS / LOCK MANAGEMENT / ERROR HANDLING
					```
					<small>
					<ul>
						<li>La plupart de ces configurations peuvent être redéfinies au niveau base de données</li>
						<li>
							<strong>
								SELECT * FROM pg_settings
							</strong>
						</li>
						<li>Sous PostgreSQL, le journal des logs s'appelle le WAL (Write Ahead Log)</li>
						<li>
							En savoir plus : <a href="http://wiki.postgresql.org/wiki/Tuning_Your_PostgreSQL_Server" target="_blank">Tuning Your PostgreSQL Server</a>
						</li>
					</ul>
					</small>
					'</script>
				</section>

				<section data-markdown>
					<script type="text/template">
					##Fichiers de config [DBA]
					###@TODO: postgresql.conf, pg_hba.cong, pg_ident.conf
					```
					$ psql -U myuser -h 127.0.0.1 mydatabase
					```
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
					##Fichiers de config [DBA]
					###@TODO: postgresql.conf, pg_hba.cong, pg_ident.conf
					```
					$ psql -U myuser -h 127.0.0.1 mydatabase
					```
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
					##Héritage de table [SQL/DDL]
					###@TODO
					```
					$ psql -U myuser -h 127.0.0.1 mydatabase
					```
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
					##Mot de passe de connexion [DBA]
					<p class="left-align">
					Le fichier **~/.pgpass** permet de se connecter sans saisir ses mots de passe. **Environnement de développement uniquement**.
					</p>

					```
					$ psql -U myuser -h 127.0.0.1 mydatabase
					```
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
					##Les fonctions fenêtres ("Windows") [SQL/DML]
					<p class="left-align">
					Ces fonctions permettent de retourner des lignes de résultats qui ont conscience les unes des autres (OVER, PARTITION BY).
					</p>

					```
					$ psql -U myuser -h 127.0.0.1 mydatabase
					```
					</script>
				</section>

				<section data-markdown class="hljs-condensed">
					<script type="text/template">
					##Liste des commandes PSQL [DBA]
					<p class="left-align">
					La commande **\?** permet de lister toutes les commandes psql disponibles, groupées par catégorie.
					</p>
					```
					postgres=# \?
					General
						\copyright             show PostgreSQL usage and distribution terms
					Input/Output
						\copy ...              perform SQL COPY with data stream to the client host
					Informational
						(options: S = show system objects, + = additional detail)
						\d[S+]                 list tables, views, and sequences
						\d[S+]  NAME           describe table, view, sequence, or index
						\da[S]  [PATTERN]      list aggregates
						\db[+]  [PATTERN]      list tablespaces
  						\dc[S+] [PATTERN]      list conversions
						\dC[+]  [PATTERN]      list casts
						[...]
					```
					</script>
				</section>

				<section data-markdown class="hljs-condensed">
					<script type="text/template">
					##Les séquences [SQL/DDL]
					<p class="left-align">Souvent utilisées pour incrémenter des clés primaires. Usage :</p>

					```
						CREATE SEQUENCE product_seq;
						CREATE TABLE product (
							#id SERIAL PRIMARY KEY, # Sequence would be created implicitely
							id INT PRIMARY KEY DEFAULT nextval('product_seq'),
							name VARCHAR(50) NOT NULL
						);
					```
					```
						# DO NOT DO THAT !!!
						INSERT INTO product (id, name) VALUE (1, "A wonderful product");
						# DO RATHER THIS :
						INSERT INTO product (id, name) VALUE (nextval('product_seq'), "A wonderful product");
					```
					```
						ALTER SEQUENCE product_seq RESTART WITH 105;
						ALTER SEQUENCE product_seq INCREMENT BY 2;
					```
					<p class="tooltip left-align midsize-font">Une séquence peut être utilisée par plusieurs tables</p>
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
					##Titre [DBA]
					Gabarit pour les slides Markdown (extraits de code)
					```
					$ psql -U myuser -h 127.0.0.1 mydatabase
					```
					</script>
				</section>

			</div>

		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>

			// Full list of configuration options available at:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				transition: 'slide', // none/fade/slide/convex/concave/zoom

				// Optional reveal.js plugins
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true },
					{ src: 'plugin/notes/notes.js', async: true }
				]
			});

		</script>

	</body>
</html>

<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>PostgreSQL – Particularités, fonctionnalités et astuces</title>

		<meta name="description" content="PostgreSQL pour les développeurs, les apprentis DBA et les utilisateurs de MySQL">
		<meta name="author" content="xavier-rdo">

		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/custom.css">
		<link rel="stylesheet" href="css/theme/black.css" id="theme">

		<!-- Code syntax highlighting -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
				<section>
					<h1>PostgreSQL</h1>
					<h4>Fonctionnalités à l'usage des développeurs, des apprentis DBA et des utilisateurs de MySQL</h4>
					<p>
						<small>
						<ul>
							<li>Novembre 2015</li>
							<li>Version de PostgreSQL de référence: 9.4</li>
						 	<li>Support de la présentation : <a target="_blank" href="https://github.com/hakimel/reveal.js">Reveal.js</a></li>
						 	<li>
						 		<i>Cette présentation propose un aperçu de certaines fonctionnalités de PostgreSQL,
								elle ne prétend nullement à l'exhaustivité.</i>
						 	</li>
						</ul>
						</small>
					</p>
					<p><img src="./images/postgresql-logo.png"></p>
				</section>

				<section>
					<h2>PostgreSQL en quelques mots</h2>
					<ul>
						<li>SGBD Open Source et performant</li>
						<li>Site officiel : <a href="www.postgresql.org" target="_blank">www.postgresql.org</a></li>
						<li>Version 1 diffusée à quelques utilisateurs en juin 1989</li>
						<li>Créateur : Michael Stonebraker (Berkeley)</li>
						<li>Version actuelle : 9.4 (décembre 2014)</li>
					</ul>
				</section>
				<section>
					<ul>
						<li>Nom officiel : PostgreSQL ("postgres" dans l'usage)</li>
						<li>Disponible pour la plupart des OS (Windows, MacOS, Unix, Linux, etc.)</li>
						<li>Drivers disponibles dans la plupart des langages (Php, Java, Python, Golang, Node.js, etc.)</li>
						<li>Des fonctionnalités, en veux-tu, en voilà ! Voir la suite ...</li>
					</ul>
				</section>

				<section>
					<h2>Terminologie</h2>
					<ul>
						<li>
							Le terme <strong><i>Cluster</i></strong> désigne souvent une instance de PostgreSQL (comprendre "cluster de bases de données")
						</li>
						<li>
							<strong>DDL</strong> : Data Definition Language (schema des données : CREATE TABLE, ALTER TABLE, INDEXES, RENAME, etc.)
						</li>
						<li>
							<strong>DML</strong> : Data Manipulation Language (INSERT, DELETE, UPDATE, SELECT, etc.)
						</li>
						<li>
							<strong>DBA</strong> : DataBase Administrator
						</li>
						<li>
							En SQL, le terme <strong><i>Relation</i></strong> désigne souvent une table (et non pas une association)
						</li>
					</ul>
				</section>

				<section>
					<h2>Outils d'administration [DBA]</h2>
					<p><a href="http://www.pgadmin.org/" target="_blank">http://www.pgadmin.org/</a></p>
					<p><img src="images/pgadmin.png"></p>
				</section>

				<section>
					<h2>Outils d'administration [DBA]</h2>
					<p><a href="http://phppgadmin.sourceforge.net" target="_blank">http://phppgadmin.sourceforge.net</a></p>
					<p><img src="images/phpPgAdmin.jpg"></p>
				</section>

				<section data-markdown>
					<script type="text/template">
					##Outils d'administration [DBA]
					##psql
					```
					$ psql -U myuser -h 127.0.0.1 mydatabase
					Password for user myuser:
					psql (9.4.2)
					SSL connection (cipher: DHE-RSA-AES256-GCM-SHA384, bits: 256)
					Type "help" for help.

					mydatabase=# SELECT * FROM mytable;
					```
					'</script>
				</section>

				<section>
					<h2>Les Rôles [DBA]</h2>
					<ul>
						<li class="fragment">Rôle de login et rôle de groupe <small>(1)</small></li>
						<li class="fragment">
							Créer un rôle de login :
							<ul>
								<li><strong><i>CREATE ROLE yves LOGIN PASSWORD 'my-password';</i></strong></li>
								<li><strong><i>CREATE ROLE myadmin LOGIN PASSWORD 'my-password' SUPERUSER;</i></strong></li>
							</ul>
						</li>
						<li class="fragment">
							Créer un rôle de groupe :
							<ul>
								<li><strong><i>CREATE ROLE admin [INHERIT|NOINHERIT];</i></strong>&nbsp;<small>(2)</small></li>
							</ul>
						</li>
						<li class="fragment">
							Ajouter un rôle de login à un rôle de groupe :
							<ul>
								<li><strong><i>GRANT admin TO yves;</i></strong></li>
							</ul>
						</li>
					</ul>
					<br/><br/>
					<ul>
					<small>
						<li>(1) CREATE USER et CREATE GROUP sont dépréciés. CREATE USER est un alias de CREATE ROLE</li>
						<li>(2) INHERIT/NOINHERIT : les privilèges sont-ils propagés aux utilisateurs du groupe ?</li>
						<li>
							L'impersonnation est possible (<i>SET ROLE</i>).
							<a href="http://www.postgresql.org/docs/9.3/static/sql-set-role.html" target="_blank">
								Cf. documentation
							</a>.
						</li>
						<li>
							En savoir plus sur les rôles :
							<a href="http://www.postgresql.org/docs/current/static/sql-createrole.html" target="_blank">
							http://www.postgresql.org/docs/current/static/sql-createrole.html
							</a>
						</li>
					</small>
					</ul>
				</section>

				<section data-markdown>
					<script type="text/template">
					##Liste des rôles [DBA]
					##psql
					La commande \du permet de lister les rôles :
					```
					$ psql -U postgres -h 127.0.0.1
					postgres=# \du
					                             List of roles
					 Role name |                   Attributes                   | Member of
					-----------+------------------------------------------------+-----------
					 postgres  | Superuser, Create role, Create DB, Replication | {}
					 admin     | Create DB                                      | {}

					```
					##SQL
					```
					SELECT * FROM pg_roles;
					```
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
					##Update avec jointure [SQL/DML]
					MySQL :
					```
					UPDATE product p
					INNER JOIN category c ON (p.category_id = c.id)
					SET p.price = p.price * 1.1
					WHERE c.name LIKE 'Sport%'
					```
					PostgreSQL :
					```
					UPDATE product
					SET price = price * 1.1
					FROM category
					WHERE product.category_id = category.id
					AND category.name LIKE 'Sport%'
					```
					<p>
					<small>
						<br/>
					    Type de requête souvent nécessaire lorsque l'on souhaite mettre à jour les données d'une table en se basant sur une
					    (ou plusieurs) condition(s) portée(s) par une table associée.
					</small>
					</p>
					</script>
				</section>

				<section>
				<section data-markdown>
					<script type="text/template">
					##Le langage PL/PGSQL [DEV]
					<p class="midsize-font left-align">
					PL/PGSQL apporte une couche procédurale au SQL. Il permet d'exécuter des reqûetes de SELECT SQL, boucler sur les résultats (<strong>CURSOR</strong>), exécuter des requêtes d'écriture (INSERT, UPDATE, DELETE, grâce à la commande <strong>EXECUTE</strong>), déclarer des variables, utiliser des conditions, des structures de boucle, etc.
					</p>
					Structure d'une fonction PL/PGSQL :
					```
						CREATE or REPLACE FUNCTION my_wonderful_function()
						RETURNS void AS
						$$
						DECLARE
							# Initialize your variables here
							rank integer := 0;
							products CURSOR FOR SELECT * FROM product;
						BEGIN
						    # Body of the function
						END;
						$$ LANGUAGE plpgsql;
					```
					'</script>
				</section>

				<section class="hljs-condensed">
					<h2>Le langage PL/PGSQL [DEV]</h2>
					<pre>
						<code class="hljs" data-trim contenteditable>
CREATE or REPLACE FUNCTION init_product_ranks()
RETURNS void AS $$
DECLARE
  rank integer := 0;
  current_category_id integer := 0;
  products CURSOR FOR SELECT * FROM product ORDER BY category_id;
BEGIN
  FOR product_row IN products LOOP
    -- reset rank to zero if category id has changed
    IF product_row.category_id <> current_category_id THEN
      current_category_id := product_row.category_id;
      rank := 0;
    END IF;
    EXECUTE 'UPDATE product SET position = ' || rank || ' WHERE id = ' || product_row.id;
    rank := rank + 1;
  END LOOP;
END;
$$ LANGUAGE plpgsql;
						</code>
					</pre>
					<p>
					<small>
					<strong>Contexte applicatif</strong> : fonction utilisée dans un script de migration pour initialiser l'ordre des produits dans le périmètre de leur catégorie, après création en table d'un nouveau champ 'rank' sur des données existantes (positionner toutes les valeurs à zéro aboutissait à des résultats complètement erratiques dans le code applicatif ; la librairie Php utilisée pour mettre à jour les tris géraient très mal les données non triées par défaut)
					</small>
					</p>
				</section>
				</section>

				<section data-markdown class="hljs-condensed">
					<script type="text/template">
					##Fichiers de config [DBA]
					Sous Debian/Ubuntu : /etc/postgresql/9.4/main/xxxxxx.conf
					###Le fichier postgresql.conf
					<p class="enum midsize-font">
					(CONFIG) FILE LOCATIONS /
					CONNECTIONS AND AUTHENTICATION (port, max connections, SSL cert files, TCP keepalives, etc.) /
					RESOURCE USAGE (except WAL) : memory, disk, etc. /
					WRITE AHEAD LOG (wal level, checkpoints, archiving, etc) /
					REPLICATION / QUERY TUNING / ERROR REPORTING AND LOGGING / RUNTIME STATISTICS /
					AUTOVACUUM PARAMETERS / CLIENT CONNECTION DEFAULTS / LOCK MANAGEMENT / ERROR HANDLING
					</p>
					<small>
					<ul>
						<li>La plupart de ces configurations peuvent être redéfinies au niveau base de données :</li>
						<li>
							<strong>
								SELECT * FROM pg_settings
							</strong>
						</li>
						<li>Sous PostgreSQL, le journal des logs s'appelle le WAL (Write Ahead Log)</li>
						<li>
							En savoir plus : <a href="http://wiki.postgresql.org/wiki/Tuning_Your_PostgreSQL_Server" target="_blank">Tuning Your PostgreSQL Server</a>
						</li>
					</ul>
					</small>
					'</script>
				</section>

				<section data-markdown class="hljs-condensed">
					<script type="text/template">
					##Fichiers de config [DBA]
					###Le fichier pg_hba.conf
					Qui peut se connecter aux bases de données et comment ?
					```
					# TYPE DATABASE USER ADDRESS METHOD
					# IPv4 local connections:
					host all all 127.0.0.1/32 ident
					# IPv6 local connections:
					host all all ::1/128 trust
					host all all 192.168.54.0/24 md5
					hostssl all all 0.0.0.0/0 md5
					# Allow replication connections from localhost, by a user with the replication privilege.
					#host replication postgres 127.0.0.1/32 trust
					#host replication postgres ::1/128 trust
					```
					<ul>
					<small>
						<li>Méthodes de connexion : ident, trust, md5, password, etc.</li>
						<li>127.0.0.1/32 : plages d'IP autorisées (addresse + bit mask)</li>
						<li>
							192.168.54.0/24 md5 :  connexion par mot de passe hashé md5 autorisée pour les utilisateurs du sous-réseau 192.168.54.0
						</li>
						<li>Nota : les actions autorisées après connexion sont déterminées par les privilèges</li>
					</small>
					</ul>
					'</script>
				</section>

				<section data-markdown>
					<script type="text/template">
					##Fichiers de config [DBA]
					###Le Fichier pg_ident.conf
					Correspondance entre les utilisateurs OS (UNIX) et les rôles de login PostgreSQL (1)
					```
					# MAPNAME       SYSTEM-USERNAME         PG-USERNAME
					robert          robert                  bobby
					```
					<ul>
						<small>
						<li>(1) Lorsque les règles de connexion (cf. pg_hba.conf) le prévoient</li>
						</small>
					</ul>
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
					##Héritage de table [SQL/DDL]
					```
						CREATE TABLE person (
							id SERIAL PRIMARY KEY NOT NULL,
							dob DATE,
							firstname VARCHAR(50),
							lastname VARCHAR(75) NOT NULL
						);

						CREATE TABLE customer (
							bank_account VARCHAR(50) NOT NULL
						) INHERITS (person) ;

					```
					<p class="left-align midsize-font">
						<br/>
						En savoir plus : <a href="http://www.postgresql.org/docs/current/static/ddl-inherit.html" target="_blank">http://www.postgresql.org/docs/current/static/ddl-inherit.html</a>
					</p>
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
					##Mot de passe de connexion [DBA]
					<p class="left-align">
					Le fichier **~/.pgpass** permet de se connecter sans saisir ses mots de passe.
					</p>

					```
					#hostname:port:database:username:password
					localhost:5432:mydatabase:myusername:myunbreakablepassword
					localhost:5432:anotherdatabase:myusername:myunbreakablepassword
					```
					```
					$ chmod 0600 ~/.pgpass
					```
					</script>
				</section>

				<section>
				<section data-markdown class="hsjs-condensed">
					<script type="text/template">
					##Les fonctions fenêtres ("Windows") [SQL/DML]
					<p class="left-align">
					Ces fonctions permettent de retourner des lignes de résultats qui ont conscience les unes des autres (mots-clés **OVER**, **PARTITION BY**).
					</p>

					```
					SELECT id, name, city FROM department;

					 id |           name           |    city
					----+--------------------------+------------
					  2 | Operations               | Lyon
					  3 | Administrative           | Lyon
					  4 | Staff                    | Lyon
					  5 | Operations               | Montpelier
					  6 | Operations               | Paris
					  1 | Research and Development | Paris
					(6 rows
					```
					<small>
					Jeu de données simple pour démonstration : liste de services situés chacun dans une ville.
					</small>
					</script>
				</section>
				<section data-markdown class="hsjs-condensed">
					<script type="text/template">
					<p class="left-align">
					Exemple avec la fonction **row_number(&nbsp;)** qui permet d'afficher' pour chaque ligne de résultats son classement relatif aux autres lignes :
					</p>
					```
					SELECT id, name, city, row_number() OVER() as RANK
					FROM department;

					 id |           name           |    city    |    rank
					----+--------------------------+------------+------------
					  2 | Operations               | Lyon       |      1
					  3 | Administrative           | Lyon       |      2
					  4 | Staff                    | Lyon       |      3
					  5 | Operations               | Montpelier |      4
					  6 | Operations               | Paris      |      5
					  1 | Research and Development | Paris      |      6
					(6 rows)

					```
					<small>
					Par rapport à la requête précédente, nous avons juste ajouté au SELECT une nouvelle colonne qui appelle la fonction row_number(&nbsp;) : **row_number(&nbsp;) OVER() as RANK**.
					</small>
					</script>
				</section>
				<section data-markdown class="hsjs-condensed">
					<script type="text/template">
					<p class="left-align">
					La même chose que précédemment mais en regroupant les services par département grâce au mot-clé PARTITION BY passé à OVER(&nbsp;) :
					</p>
					```
					SELECT id, name, city, row_number()
					OVER(PARTITION BY city) as relative_rank
					FROM department;

					 id |           name           |    city     | relative_rank
					----+--------------------------+-------------+---------------
					  2 | Operations               | Lyon        |             1
					  3 | Administrative           | Lyon        |             2
					  4 | Staff                    | Lyon        |             3
					  5 | Operations               | Montpellier |             1
					  6 | Operations               | Paris       |             1
					  1 | Research and Development | Paris       |             2
					(6 rows)

					```
					<small>
					La requête ci-dessus affiche le classement de chaque service au sein de sa ville. Nous avons partitionné les résultats par ville (city).
					</small>
					</script>
				</section>
				<section data-markdown class="hsjs-condensed">
					<script type="text/template">
					<p class="left-align">
						Autre fonction 'Window' : **first_value(field_name)**
					</p>
					```
					SELECT id, name, city, first_value(city) OVER()
					FROM department;

					 id |           name           |    city     | first_value
					----+--------------------------+-------------+-------------
					  2 | Operations               | Lyon        | Lyon
					  3 | Administrative           | Lyon        | Lyon
					  4 | Staff                    | Lyon        | Lyon
					  5 | Operations               | Montpellier | Lyon
					  6 | Operations               | Paris       | Lyon
					  1 | Research and Development | Paris       | Lyon
					(6 rows)
					```
					<small>
					Tous les résultats contiennent une colonne portant la valeur que possède le champ 'city' dans la première ligne de résultats.
					</small>
					</script>
				</section>
				<section>
					<h2>Les autres fonctions "Window"</h2>
					<ul>
						<small>
						<li>
							<strong>rank(&nbsp;)</strong> : même chose que row_number(&nbsp;) mais gère les rangs égaux (deux enregistrements à la même position) et l'écart du suivant (si deux enregistrements occupent la 2ème position, le suivant sera en 4ème position)
						</li>
						<li>
							<strong>dense_rank(&nbsp;)</strong> : même chose que ci-dessus mais ne gère pas l'écart du suivant
						</li>
						<li>
							<strong>last_value(field_name)</strong> l'équivalent de first_value(&nbsp;) pour la dernière ligne de résultat
						</li>
						<li>
							<strong>nth_value(field_name, n)</strong>
						</li>
						<li>
							<strong>lag(field_name)</strong>, <strong>lead(field_name)</strong> : retourne la valeur du champ 'field_name' dans l'enregistrement précédent (lag) ou suivant (lead)
						</li>
						<li>et aussi percent_rank(), ntile(), etc.</li>
						</small>
						<p>
						En savoir plus : <a href="http://www.postgresql.org/docs/current/static/tutorial-window.html" target="_blank">Tutoriel sur les fonctions Windows</a> (et notamment comment les combiner à des fonctions d'aggrégation telles que AVG ou SUM). <a href="http://www.postgresql.org/docs/current/static/functions-window.html" target="_blank">Liste complète des fonctions Window</a>.
						<p>
					</ul>
				</section>
				</section>

				<section data-markdown class="hljs-condensed">
					<script type="text/template">
					##Liste des commandes PSQL [DBA]
					<p class="left-align">
					La commande **\?** permet de lister toutes les commandes psql disponibles, groupées par catégorie.
					</p>
					```
					postgres=# \?
					General
						\copyright             show PostgreSQL usage and distribution terms
					Input/Output
						\copy ...              perform SQL COPY with data stream to the client host
					Informational
						(options: S = show system objects, + = additional detail)
						\d[S+]                 list tables, views, and sequences
						\d[S+]  NAME           describe table, view, sequence, or index
						\da[S]  [PATTERN]      list aggregates
						\db[+]  [PATTERN]      list tablespaces
  						\dc[S+] [PATTERN]      list conversions
						\dC[+]  [PATTERN]      list casts
						[...]
					```
					</script>
				</section>

				<section data-markdown class="hljs-condensed">
					<script type="text/template">
					##Les séquences [SQL/DDL]
					<p class="left-align">Souvent utilisées pour incrémenter des clés primaires. Usage :</p>

					```
						CREATE SEQUENCE product_seq;
						CREATE TABLE product (
							#id SERIAL PRIMARY KEY, # Sequence would be created implicitely
							id INT PRIMARY KEY DEFAULT nextval('product_seq'),
							name VARCHAR(50) NOT NULL
						);
					```
					```
						# DO NOT DO THAT !!!
						INSERT INTO product (id, name) VALUE (1, "A wonderful product");
						# DO RATHER THIS :
						INSERT INTO product (id, name) VALUE (nextval('product_seq'), "A wonderful product");
					```
					```
						ALTER SEQUENCE product_seq RESTART WITH 105;
						ALTER SEQUENCE product_seq INCREMENT BY 2;
					```
					<p class="tooltip left-align midsize-font">Une séquence peut être utilisée par plusieurs tables</p>
					</script>
				</section>

				<section>
				<section data-markdown>
					<script type="text/template">
					##Les expressions conditionnelles [SQL/DML]
					###CASE
					```
					SELECT name, city,
					CASE WHEN city = 'Paris' THEN city ELSE 'Province' END AS Location
					FROM department;

					           name           |    city     | location
					--------------------------+-------------+----------
					 Operations               | Lyon        | Province
					 Administrative           | Lyon        | Province
					 Staff                    | Lyon        | Province
					 Operations               | Montpellier | Province
					 Operations               | Paris       | Paris
					 Research and Development | Paris       | Paris

					```
					</script>
				</section>
				<section data-markdown>
					<script type="text/template">
					##Les expressions conditionnelles [SQL/DML]
					###COALESCE
					Retourne la valeur du premier champ non null.
					```
					SELECT COALESCE(body, abstract, header, '(none)') FROM cms_articles;

					```
					</script>
				</section>
				<section data-markdown>
					<script type="text/template">
					##Les expressions conditionnelles [SQL/DML]
					###NULLIF
					Retourne NULL lorsqu'un champ possède une certaine valeur.
					```
					SELECT NULLIF(city, 'Montpellier') FROM department;

					```
					'</script>
				</section>
				<section data-markdown>
					<script type="text/template">
					##Les expressions conditionnelles [SQL/DML]
					###GREATEST et LEAST
					Retourne la valeur la plus élevée (ou la plus basse) de plusieurs champs.
					```
					SELECT GREATEST(salary, base_salary) FROM employee;

					```
					</script>
				</section>
				</section>

				<section data-markdown class="hljs-condensed">
					<script type="text/template">
					##PSQL / Affichage des résultats [DBA]
					Utiliser la commande \x pour afficher les colonnes de résultats verticalement :
					```
					=> \x
					=> SELECT * FROM pg_roles;

					-[ RECORD 1 ]--+---------
					rolname        | postgres
					rolsuper       | t
					rolinherit     | t
					rolcreaterole  | t
					...

					```
					Saisir à nouveau \x pour revenir au mode d'affichage par défaut.
					'</script>
				</section>

				<section data-markdown>
					<script type="text/template">
					##Statistiques [DBA]
					<br/>
					```
					SELECT * FROM pg_stat_activity;
					```
					<p class="left-align midsize-font">
						Activité courante des process Postgress. <br/>En savoir plus : <a href="http://www.postgresql.org/docs/current/static/monitoring.html">Monitoring Database Activity</a>.
					</p>

					<br/>
					```
					SELECT * FROM pg_stats WHERE tablename LIKE 'employee';
					```
					<p class="left-align midsize-font">
						En savoir plus : le catalogue <a href="http://www.postgresql.org/docs/9.2/static/view-pg-stats.html">pg_stats</a>
					</p>

					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
					##Résultats d'une requête SQL [SQL/DML]
					Utiliser 'RETURNING dans une requête de DELETE/UPDATE/INSERT :
					```
					UPDATE department
					SET city = 'Montpellier'
					WHERE city LIKE 'Montpelier'
					RETURNING id, name, city;

					 id |    name    |    city
					----+------------+-------------
					  5 | Operations | Montpellier
					(1 row)

					UPDATE 1
					```
					</script>
				</section>


				<section data-markdown>
					<script type="text/template">
					##Les schémas [SQL/DDL]
					<p class="midsize-font">
					<ul>
						<li class="fragment">Niveau d'organisation intermédiaire entre la base de données et ses objets (dont les tables).</li>
						<li class="fragment">Le schéma "public" est créé par défaut en même temps que la base de données</li>
						<li class="fragment">Moyen de regrouper logiquement ses objets (tables, fonctions, vues, etc.)</li>
						<li class="fragment">Les schémas peuvent également faciliter la gestion des privilèges (découpage de la base en schémas par rôles)</li>
						<li class="fragment">Création : CREATE SCHEMA my_schema</li>
						<li class="fragment">Déplacer une table : ALTER TABLE my_table SET SCHEMA my_schema</li>
						<li class="fragment">Nouvelle table : CREATE TABLE my_schema.my_table [...]</li>
					</ul>
					</p>
					'</script>
				</section>

				<section data-markdown class="hljs-condensed">
					<script type="text/template">
					##Les privilèges [DBA]

					<p class="enum midsize-font">
					SELECT / INSERT / UPDATE / DELETE / TRUNCATE / REFERENCES / TRIGGER /
					CREATE (databases, schemas, indexes, tablespaces, etc.) /
					CONNECT (to database) / TEMPORARY (tables) / EXECUTE (functions) /
					USAGE (access to schema objects) / ALL PRIVILEGES
					</p>

					<small>Ces privilèges peuvent être accordés (**<a href="http://www.postgresql.org/docs/current/static/sql-grant.html" target="_blank">GRANT</a>**) ou retirés (**<a href="http://www.postgresql.org/docs/current/static/sql-revoke.html" target="_blank">REVOKE</a>**) aux rôles.</small>
					```
					GRANT { { SELECT | INSERT | UPDATE | DELETE | TRUNCATE | REFERENCES | TRIGGER }
					    [,...] | ALL [ PRIVILEGES ] }
					    ON { [ TABLE ] table_name [, ...]
					         | ALL TABLES IN SCHEMA schema_name [, ...] }
					    TO { [ GROUP ] role_name | PUBLIC } [, ...] [ WITH GRANT OPTION ]
					```
					```
					REVOKE [ GRANT OPTION FOR ]
					    { { SELECT | INSERT | UPDATE | DELETE | TRUNCATE | REFERENCES | TRIGGER }
					    [, ...] | ALL [ PRIVILEGES ] }
					    ON { [ TABLE ] table_name [, ...]
					         | ALL TABLES IN SCHEMA schema_name [, ...] }
					    FROM { [ GROUP ] role_name | PUBLIC } [, ...]
					    [ CASCADE | RESTRICT ]

					```
					<p class="tooltip smallsize-font">
						Si vous avez créé des schémas, n'oubliez pas d'accorder le privilège <strong>USAGE</strong> à vos rôles !
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
					##Les types de champs [SQL/DDL]
					<p class="midsize-font">
					Réf. : <a href="http://www.postgresql.org/docs/current/static/datatype.html" target="_blank">http://www.postgresql.org/docs/current/static/datatype.html</a>
					</p>
					TL;DR :
					<p class="enum smallsize-font">
					Numeric (int, numbers, float, serial) ; monetary ; character ; binary data (bytea) ; date/time ; boolean ; enumerated ; geometric (point, line, line segment, box, path, polygon, circle) ; network address (inet, cidr, macaddr, inet vs. cidr) ; text search (tsvector, tsquery) ; UUID ; XML ; JSON (and JSONB) ; array ; composite ; range ; object identifier ; pseudo-types ; pg_lsn (Log Sequence Number).
					</p>

					```
					CAST(expression AS type)    # eg: CAST(salary AS int)
					expression::type            # eg: salary::int
					```
					<p class="tooltip smallsize-font">
					Chaque type possède des <strong>fonctions et des opérateurs</strong> qui lui sont propres ; pensez à consulter la documentation (Read The Fine Manual, RTFM) : <a href="http://www.postgresql.org/docs/current/static/functions.html" target="_blank">http://www.postgresql.org/docs/current/static/functions.html</a>
					</p>
					</script>
				</section>

				<section>
				<section>
					<h2>Les index [SQL/DDL]</h2>
					<h3>Les types d'index :</h3>
					<ul class="midsize-font">
						<li><strong>B-Tree</strong> (défaut) : adapté aux types numériques et varchar</li>
						<li><strong>GiST</strong> (Generalized Search Tree) : optimisé pour les recherches full-text, les données spatiales, scientifiques, hiérarchiques ...</li>
						<li><strong>GIN</strong> (Generalized Inverted Index) : concentré sur les recherches full-text et les types JSONB (JSON binaire)</li>
						<li>Les autres types : SP-GiST (Space-Partioning Trees GiST), hash, B-Tree-GiST/B-Tree Gin, etc.</li>
					</ul>
					<p class="warning smallsize-font">
					<strong>Les index ont un impact sur le volume des données et sur les performances en écriture</strong>
					</p>
				</section>
				<section data-markdown>
					<script type="text/template">
					<p class="tooltip left-align">
					Les index partiels
					</p>
					```
					CREATE UNIQUE INDEX subscriber_unique_if_active_idx
					ON subscribers USING btree(lower(lastname))
					WHERE is_active;
					```

					<p class="tooltip left-align">Taille des index et des tables ?</p>
					```
					-- Show table size without indexes
					SELECT pg_size_pretty(pg_relation_size('table_name'));
					-- Show table size with indexes
					SELECT pg_size_pretty(pg_total_relation_size('table_name'));
					-- Show index size :
					SELECT pg_size_pretty(pg_relation_size('index_name'));
					```
					<p>
						Voir également :
					</p>
					<ul class="midsize-font">
						<li>
							<a href="https://wiki.postgresql.org/wiki/Index_Maintenance#Index_size.2Fusage_statistics" target="_blank">
								Index Maintenance
							</a>
						</li>
						<li>
							<a href="https://wiki.postgresql.org/wiki/Disk_Usage" target="_blank">
							Disk Usage
							</a>
						</li>
					</ul>
					</script>
				</section>
				</section>

				<section data-markdown>
					<script type="text/template">
					##Les contraintes (CHECK) [SQL/DDL]
					###PRIMARY KEY
					###FOREIGN KEY (REFERENCES)
					###UNIQUE
					###NOT NULL
					###CHECK :
					```
					ALTER TABLE products
					ADD CONSTRAINT products_price
					CHECK (price > 0);

					ALTER TABLE products
					ADD CONSTRAINT products_discounted_price
					CHECK (discounted_price > 0 AND price > discounted_price);
					```
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
					## La contrainte EXCLUDE [SQL/DDL]

					```
					CREATE EXTENSION btree_gist;

					-- Reject INSERT if room is equal (=) and during (&&) overlaps :
					CREATE TABLE room_reservation (
					    room text,
					    during tsrange,
					    EXCLUDE USING gist (room WITH =, during WITH &&)
					);
					```

					```
					-- First insert is OK
					INSERT INTO reservation VALUES
					    ('123A', '[2010-01-01 11:30, 2010-01-01 15:00)');
					INSERT 0 1

					-- Second insert should not !
					INSERT INTO reservation VALUES
					    ('123A', '[2010-01-01 14:30, 2010-01-01 15:30)');
					```

					```
					ERROR:  conflicting key value violates exclusion constraint "room_reservation_room_during_excl"
					DETAIL:  Key (room, during)=(123A, ["2010-01-01 14:30:00","2010-01-01 15:30:00")) conflicts
					with existing key (room, during)=(123A, ["2010-01-01 11:30:00","2010-01-01 15:00:00"))
					```

					<small>Réf. : <a href="http://www.postgresql.org/docs/current/static/rangetypes.html#RANGETYPES-CONSTRAINT" target="_blank">http://www.postgresql.org/docs/current/static/rangetypes.html</a></small>
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
					##JSON [SQL/DDL]
					<h3>
						<a href="http://www.postgresql.org/docs/current/static/datatype-json.html" target="_blank">Les types JSON</a> (JSON & JSONB)
					</h3>
					<p class="tooltip smallsize-font">
						Le type JSONB altère le formatage des données (suppression espaces superflus, retours charriot) mais est plus efficace que le type JSON lors des traitements (requêtes, parcours, etc.)
					</p>
					<h3>
						<a href="http://www.postgresql.org/docs/current/static/functions-json.html" target="_blank">
						Fonctions et opérateurs
						</a>
					</h3>
					<h3>La fonction row_to_json :</h3>
					```
					SELECT row_to_json(departments) AS json_departments
					FROM (SELECT * FROM department) AS departments;
					```

					```
					                     json_departments
					-----------------------------------------------------------
					 {"id":2,"name":"Operations","city":"Lyon"}
					 {"id":3,"name":"Administrative","city":"Lyon"}
					 {"id":4,"name":"Staff","city":"Lyon"}
					 {"id":1,"name":"Research and Development","city":"Paris"}
					 {"id":5,"name":"Operations","city":"Montpellier"}
					 (5 rows)
					```
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
					##Les Triggers [DEV]
					Gabarit pour les slides Markdown (extraits de code)
					```
					$ psql -U myuser -h 127.0.0.1 mydatabase
					```
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
					##Foreign Data Wrapper (FDW) [DBA]
					Tables virtuelles vers des sources de données externes.
					<table>
						<thead>
							<tr>
								<th width="50%">File</th>
								<th width="50%">Postgres</th>
							</tr>
						</thead>
						<tbody class="smallsize-font">
							<tr>
								<td>
									CREATE EXTENSION file_fdw;
								</td>
								<td>
									CREATE EXTENSION postgres_fdw;
								</td>
							</tr>
							<tr>
								<td>
									CREATE SERVER my_fileserver <br/>FOREIGN DATA WRAPPER file_fdw;
								</td>
								<td>
									CREATE SERVER my_pgserver <br/>
									FOREIGN DATA WRAPPER postgres_fdw</br>
									OPTIONS ( host 'localhost', port '5432', dbname 'another_db');
								</td>
							</tr>
							<tr>
								<td>
								CREATE FOREIGN TABLE my_table (<br/>
									id INT, lastname VARCHAR(50), etc. <br/>
								) SERVER my_fileserver<br/>
								OPTIONS ( filename '/home/xavier/customer.csv', format 'csv');
								</td>
								<td>
									<i>Nil</i>
								</td>
							</tr>
							<tr>
								<td>
									<i>Nil</i>
								</td>
								<td>
								CREATE USER MAPPING FOR public SERVER my_pgserver
								OPTIONS (user 'role_on_foreign', password 'your_password');
								</td>
							</tr>
						</tbody>
					</table>
					<ul class="smallsize-font">
					    <li>Le site <a href="http://pgxn.org/tag/foreign%20data%20wrapper/" target="_blank">PGXN</a> recense quelques drivers externes disponibles.
					    </li>
					    <li>
					    	Quelques exemples : json_fdw, CouchDb, MongoDb, Redis, Oracle, etc.
					    </li>
					</ul>
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
					##Les extensions [DEV]
					Gabarit pour les slides Markdown (extraits de code)
					```
					$ psql -U myuser -h 127.0.0.1 mydatabase
					```
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
					##Titre [DBA]
					Gabarit pour les slides Markdown (extraits de code)
					```
					$ psql -U myuser -h 127.0.0.1 mydatabase
					```
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
					##Titre [DBA]
					Gabarit pour les slides Markdown (extraits de code)
					```
					$ psql -U myuser -h 127.0.0.1 mydatabase
					```
					</script>
				</section>

				<section data-markdown>
					<script type="text/template">
					##Titre [DBA]
					Gabarit pour les slides Markdown (extraits de code)
					```
					$ psql -U myuser -h 127.0.0.1 mydatabase
					```
					</script>
				</section>

			</div>

		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>

			// Full list of configuration options available at:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				transition: 'slide', // none/fade/slide/convex/concave/zoom

				// Optional reveal.js plugins
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true },
					{ src: 'plugin/notes/notes.js', async: true }
				]
			});

		</script>

	</body>
</html>
